<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ともだちキラキラおもいでパズル</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
            padding: 10px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            padding: 20px;
            text-align: center;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 25px;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 120px;
            touch-action: manipulation;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .button:active {
            transform: translateY(0);
        }

        .difficulty-buttons .button {
            display: block;
            width: 100%;
            margin: 10px auto;
        }

        .difficulty-buttons .button.easy { 
            background: linear-gradient(45deg, #2ecc71, #27ae60); 
        }
        
        .difficulty-buttons .button.normal { 
            background: linear-gradient(45deg, #3498db, #2980b9); 
        }

        .difficulty-buttons .button.hard { 
            background: linear-gradient(45deg, #f39c12, #e67e22); 
        }

        .difficulty-buttons .button.oni { 
            background: linear-gradient(45deg, #e74c3c, #c0392b); 
        }

        .difficulty-buttons .button.choyaba { 
            background: linear-gradient(45deg, #8e44ad, #7d3c98);
            animation: rainbow 2s linear infinite;
        }

        @keyframes rainbow {
            0% { background: linear-gradient(45deg, #e74c3c, #f39c12); }
            25% { background: linear-gradient(45deg, #f39c12, #2ecc71); }
            50% { background: linear-gradient(45deg, #2ecc71, #3498db); }
            75% { background: linear-gradient(45deg, #3498db, #9b59b6); }
            100% { background: linear-gradient(45deg, #9b59b6, #e74c3c); }
        }

        .puzzle-container {
            margin: 20px auto;
            display: inline-block;
            border: 3px solid #333;
            border-radius: 10px;
            overflow: hidden;
            background: #f0f0f0;
            max-width: 100%;
            box-sizing: border-box;
        }

        .puzzle-grid {
            display: grid;
            gap: 1px;
            background: #333;
            padding: 1px;
            max-width: 100%;
            overflow: hidden;
        }

        .puzzle-piece {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
            touch-action: manipulation;
        }

        .puzzle-piece:hover {
            border-color: #ff6b6b;
        }

        .puzzle-piece.empty {
            background: #ddd;
            cursor: default;
        }

        .puzzle-piece.empty:hover {
            border-color: transparent;
        }

        .moves-counter {
            margin: 10px 0;
            font-size: 18px;
            color: #333;
            font-weight: bold;
        }

        .picture-select {
            margin: 20px 0;
        }

        .picture-option {
            display: inline-block;
            width: 80px;
            height: 80px;
            margin: 5px;
            border: 3px solid transparent;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .picture-option:hover, .picture-option.selected {
            border-color: #ff6b6b;
            transform: scale(1.05);
        }

        .congratulations {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .back-button {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            margin-top: 15px;
        }

        .game-title {
            font-size: 28px;
            background: linear-gradient(45deg, #ff6b6b, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .loading-message {
            color: #666;
            font-style: italic;
            margin: 10px 0;
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 10px;
                max-width: 95vw;
            }
            
            h1, .game-title {
                font-size: 20px;
            }
            
            h2 {
                font-size: 18px;
            }
            
            .button {
                padding: 10px 15px;
                font-size: 14px;
                margin: 5px;
            }
            
            .moves-counter {
                font-size: 16px;
            }
            
            .puzzle-container {
                margin: 10px auto;
                border: 2px solid #333;
            }
            
            .puzzle-grid {
                gap: 1px;
                padding: 1px;
            }
        }

        @media (max-width: 360px) {
            .game-container {
                padding: 8px;
                max-width: 98vw;
            }
            
            .button {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            h1, .game-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- タイトル画面 -->
        <div id="title-screen" class="screen active">
            <h1 class="game-title">🧩 できるんです！パズル 🧩</h1>
            <p class="subtitle">楽しいスライドパズルゲーム</p>
            <div class="loading-message" id="loading-message">画像を読み込み中...</div>
            <button class="button" id="start-button" onclick="goToPictureSelect()" style="display: none;">ゲームスタート</button>
        </div>

        <!-- 絵柄選択画面 -->
        <div id="picture-select-screen" class="screen">
            <h2>絵柄を選ぼう！</h2>
            <div class="picture-select" id="picture-options">
                <div class="picture-option selected" onclick="selectPicture(0)" data-picture="0"></div>
            </div>
            <button class="button" onclick="goToDifficultySelect()">この絵柄で遊ぶ</button>
            <button class="button back-button" onclick="goToTitle()">戻る</button>
        </div>

        <!-- 難易度選択画面 -->
        <div id="difficulty-select-screen" class="screen">
            <h2>難易度を選ぼう！</h2>
            <div class="difficulty-buttons">
                <button class="button easy" onclick="startGame(3)">かんたん (3×3)</button>
                <button class="button normal" onclick="startGame(4)">ふつう (4×4)</button>
                <button class="button hard" onclick="startGame(5)">むずい (5×5)</button>
                <button class="button oni" onclick="startGame(9)">おに (9×9)</button>
                <button class="button choyaba" onclick="startGame(11)">ちょーヤバ (11×11)</button>
            </div>
            <button class="button back-button" onclick="goToPictureSelect()">戻る</button>
        </div>

        <!-- ゲーム画面 -->
        <div id="game-screen" class="screen">
            <h2>パズルを解いてね！</h2>
            <div class="moves-counter">動かした回数: <span id="moves">0</span></div>
            <div class="puzzle-container">
                <div id="puzzle-grid" class="puzzle-grid"></div>
            </div>
            <button class="button back-button" onclick="goToDifficultySelect()">難易度選択に戻る</button>
        </div>

        <!-- クリア画面 -->
        <div id="clear-screen" class="screen">
            <div class="congratulations">
                <h2>🎉 おめでとう！ 🎉</h2>
                <p>パズルクリア！</p>
                <p><span id="final-moves"></span>回で完成させました</p>
            </div>
            <button class="button" onclick="goToPictureSelect()">次のパズルに挑戦</button>
            <button class="button back-button" onclick="goToTitle()">タイトルに戻る</button>
        </div>
    </div>

    <script>
        // ゲーム状態
        let currentPicture = 0;
        let currentSize = 3;
        let moves = 0;
        let puzzleGrid = [];
        let gameImages = [];
        let imagesLoaded = false;

        // 画面切り替え関数
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function goToTitle() {
            showScreen('title-screen');
        }

        function goToPictureSelect() {
            if (!imagesLoaded) {
                alert('画像の読み込みが完了していません。しばらくお待ちください。');
                return;
            }
            updatePictureOptions();
            showScreen('picture-select-screen');
        }

        function goToDifficultySelect() {
            showScreen('difficulty-select-screen');
        }

        // 絵柄選択
        function selectPicture(index) {
            currentPicture = index;
            document.querySelectorAll('.picture-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-picture="${index}"]`).classList.add('selected');
        }

        function updatePictureOptions() {
            const container = document.getElementById('picture-options');
            container.innerHTML = '';
            
            gameImages.forEach((imageData, index) => {
                const option = document.createElement('div');
                option.className = 'picture-option' + (index === 0 ? ' selected' : '');
                option.style.backgroundImage = `url(${imageData})`;
                option.setAttribute('data-picture', index.toString());
                option.onclick = () => selectPicture(index);
                container.appendChild(option);
            });
        }

        // ローカル画像を読み込む
        function loadLocalImages() {
            const imagePaths = [
                'images/001.png'
                // 他の画像がある場合はここに追加
                // 'images/002.png',
                // 'images/003.png'
            ];

            let loadedCount = 0;
            const totalImages = imagePaths.length;

            imagePaths.forEach((path, index) => {
                const img = new Image();
                
                img.onload = function() {
                    // 画像を正方形にリサイズ
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 400;
                    canvas.height = 400;
                    
                    const minSize = Math.min(img.width, img.height);
                    const startX = (img.width - minSize) / 2;
                    const startY = (img.height - minSize) / 2;
                    
                    ctx.drawImage(img, startX, startY, minSize, minSize, 0, 0, 400, 400);
                    
                    gameImages[index] = canvas.toDataURL();
                    loadedCount++;
                    
                    console.log(`画像 ${index + 1}/${totalImages} 読み込み完了: ${path}`);
                    
                    if (loadedCount === totalImages) {
                        onAllImagesLoaded();
                    }
                };
                
                img.onerror = function() {
                    console.log(`画像読み込み失敗: ${path}`);
                    // エラーの場合はサンプル画像を作成
                    gameImages[index] = createSampleImage(index);
                    loadedCount++;
                    
                    if (loadedCount === totalImages) {
                        onAllImagesLoaded();
                    }
                };
                
                img.src = path;
            });
        }

        function onAllImagesLoaded() {
            imagesLoaded = true;
            document.getElementById('loading-message').style.display = 'none';
            document.getElementById('start-button').style.display = 'inline-block';
            console.log('すべての画像の読み込みが完了しました！');
        }

        // サンプル画像を作成（フォールバック用）
        function createSampleImage(index) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 300;
            canvas.height = 300;
            
            // 各画像ごとに異なる色のグラデーション
            const colors = [
                ['#ff6b6b', '#3498db', '#2ecc71'],
                ['#9b59b6', '#e74c3c', '#f39c12'],
                ['#1abc9c', '#34495e', '#e67e22']
            ];
            
            const colorSet = colors[index % colors.length];
            const gradient = ctx.createLinearGradient(0, 0, 300, 300);
            gradient.addColorStop(0, colorSet[0]);
            gradient.addColorStop(0.5, colorSet[1]);
            gradient.addColorStop(1, colorSet[2]);
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 300, 300);
            
            // 図形を追加
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath();
            ctx.arc(80, 80, 30, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.beginPath();
            ctx.arc(220, 80, 40, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.beginPath();
            ctx.arc(150, 220, 50, 0, Math.PI * 2);
            ctx.fill();
            
            // テキスト
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`画像${index + 1}`, 150, 150);
            
            return canvas.toDataURL();
        }

        // ゲーム開始
        function startGame(size) {
            currentSize = size;
            moves = 0;
            document.getElementById('moves').textContent = moves;
            initializePuzzle();
            showScreen('game-screen');
        }

        // パズル初期化
        function initializePuzzle() {
            const container = document.getElementById('puzzle-grid');
            
            // 画面サイズとパディングを考慮してパズルサイズを調整
            const containerPadding = 60; // コンテナの余白
            const screenWidth = window.innerWidth - containerPadding;
            const screenHeight = window.innerHeight - 300; // UI要素分を除く
            
            let maxSize;
            if (currentSize <= 4) {
                maxSize = Math.min(screenWidth * 0.85, screenHeight * 0.7, 320);
            } else if (currentSize <= 6) {
                maxSize = Math.min(screenWidth * 0.90, screenHeight * 0.75, 360);
            } else if (currentSize <= 9) {
                maxSize = Math.min(screenWidth * 0.95, screenHeight * 0.8, 380);
            } else {
                // ちょーヤバは特に小さく
                maxSize = Math.min(screenWidth * 0.98, screenHeight * 0.85, 400);
            }
            
            const pieceSize = Math.floor(maxSize / currentSize);
            
            container.style.gridTemplateColumns = `repeat(${currentSize}, ${pieceSize}px)`;
            container.innerHTML = '';
            
            // パズルピースの配列を作成
            puzzleGrid = [];
            for (let i = 0; i < currentSize * currentSize - 1; i++) {
                puzzleGrid.push(i);
            }
            puzzleGrid.push(null); // 空のピース
            
            // シャッフル（大きなパズルほど多くシャッフル）
            shufflePuzzle();
            
            // DOM要素を作成
            renderPuzzle(pieceSize);
        }

        function shufflePuzzle() {
            // 解ける状態を保証するシャッフル（難易度に応じて調整）
            let shuffleCount;
            if (currentSize <= 4) {
                shuffleCount = 1000;
            } else if (currentSize <= 6) {
                shuffleCount = 2000;
            } else if (currentSize <= 9) {
                shuffleCount = 3000;
            } else {
                shuffleCount = 5000; // ちょーヤバは特別に多く
            }
            
            for (let i = 0; i < shuffleCount; i++) {
                const emptyIndex = puzzleGrid.indexOf(null);
                const possibleMoves = getPossibleMoves(emptyIndex);
                if (possibleMoves.length > 0) {
                    const randomMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                    [puzzleGrid[emptyIndex], puzzleGrid[randomMove]] = [puzzleGrid[randomMove], puzzleGrid[emptyIndex]];
                }
            }
        }

        function getPossibleMoves(emptyIndex) {
            const moves = [];
            const row = Math.floor(emptyIndex / currentSize);
            const col = emptyIndex % currentSize;
            
            if (row > 0) moves.push(emptyIndex - currentSize); // 上
            if (row < currentSize - 1) moves.push(emptyIndex + currentSize); // 下
            if (col > 0) moves.push(emptyIndex - 1); // 左
            if (col < currentSize - 1) moves.push(emptyIndex + 1); // 右
            
            return moves;
        }

        function renderPuzzle(pieceSize) {
            const container = document.getElementById('puzzle-grid');
            container.innerHTML = '';
            
            puzzleGrid.forEach((piece, index) => {
                const pieceElement = document.createElement('div');
                pieceElement.className = 'puzzle-piece';
                pieceElement.style.width = `${pieceSize}px`;
                pieceElement.style.height = `${pieceSize}px`;
                
                if (piece === null) {
                    pieceElement.classList.add('empty');
                } else {
                    const row = Math.floor(piece / currentSize);
                    const col = piece % currentSize;
                    const bgX = -(col * pieceSize);
                    const bgY = -(row * pieceSize);
                    const totalSize = pieceSize * currentSize;
                    
                    pieceElement.style.backgroundImage = `url(${gameImages[currentPicture]})`;
                    pieceElement.style.backgroundSize = `${totalSize}px ${totalSize}px`;
                    pieceElement.style.backgroundPosition = `${bgX}px ${bgY}px`;
                    
                    pieceElement.onclick = () => movePiece(index);
                    
                    // タッチ操作対応
                    pieceElement.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        movePiece(index);
                    });
                }
                
                container.appendChild(pieceElement);
            });
        }

        function movePiece(clickedIndex) {
            const emptyIndex = puzzleGrid.indexOf(null);
            const possibleMoves = getPossibleMoves(emptyIndex);
            
            if (possibleMoves.includes(clickedIndex)) {
                // ピースを移動
                [puzzleGrid[emptyIndex], puzzleGrid[clickedIndex]] = [puzzleGrid[clickedIndex], puzzleGrid[emptyIndex]];
                moves++;
                document.getElementById('moves').textContent = moves;
                
                // パズルサイズに応じて再計算（初期化と同じロジック）
                const containerPadding = 60;
                const screenWidth = window.innerWidth - containerPadding;
                const screenHeight = window.innerHeight - 300;
                
                let maxSize;
                if (currentSize <= 4) {
                    maxSize = Math.min(screenWidth * 0.85, screenHeight * 0.7, 320);
                } else if (currentSize <= 6) {
                    maxSize = Math.min(screenWidth * 0.90, screenHeight * 0.75, 360);
                } else if (currentSize <= 9) {
                    maxSize = Math.min(screenWidth * 0.95, screenHeight * 0.8, 380);
                } else {
                    maxSize = Math.min(screenWidth * 0.98, screenHeight * 0.85, 400);
                }
                
                const pieceSize = Math.floor(maxSize / currentSize);
                renderPuzzle(pieceSize);
                
                // クリアチェック
                if (checkWin()) {
                    setTimeout(showClear, 500);
                }
            }
        }

        function checkWin() {
            for (let i = 0; i < puzzleGrid.length - 1; i++) {
                if (puzzleGrid[i] !== i) return false;
            }
            return puzzleGrid[puzzleGrid.length - 1] === null;
        }

        function showClear() {
            document.getElementById('final-moves').textContent = moves;
            showScreen('clear-screen');
        }

        // 初期化
        window.onload = function() {
            console.log('ゲーム開始 - ローカル画像を読み込み中...');
            loadLocalImages();
        }
    </script>
</body>
</html>
