<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¨ã‚‚ã ã¡ã‚­ãƒ©ã‚­ãƒ©ãŠã‚‚ã„ã§ãƒ‘ã‚ºãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
            padding: 10px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            padding: 20px;
            text-align: center;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 25px;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 120px;
            touch-action: manipulation;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .button:active {
            transform: translateY(0);
        }

        .difficulty-buttons .button {
            display: block;
            width: 100%;
            margin: 10px auto;
        }

        .difficulty-buttons .button.easy { 
            background: linear-gradient(45deg, #2ecc71, #27ae60); 
        }
        
        .difficulty-buttons .button.normal { 
            background: linear-gradient(45deg, #3498db, #2980b9); 
        }

        .difficulty-buttons .button.hard { 
            background: linear-gradient(45deg, #f39c12, #e67e22); 
        }

        .difficulty-buttons .button.oni { 
            background: linear-gradient(45deg, #e74c3c, #c0392b); 
        }

        .difficulty-buttons .button.choyaba { 
            background: linear-gradient(45deg, #8e44ad, #7d3c98);
            animation: rainbow 2s linear infinite;
        }

        @keyframes rainbow {
            0% { background: linear-gradient(45deg, #e74c3c, #f39c12); }
            25% { background: linear-gradient(45deg, #f39c12, #2ecc71); }
            50% { background: linear-gradient(45deg, #2ecc71, #3498db); }
            75% { background: linear-gradient(45deg, #3498db, #9b59b6); }
            100% { background: linear-gradient(45deg, #9b59b6, #e74c3c); }
        }

        .puzzle-container {
            margin: 20px auto;
            display: inline-block;
            border: 3px solid #333;
            border-radius: 10px;
            overflow: hidden;
            background: #f0f0f0;
            max-width: 100%;
            box-sizing: border-box;
        }

        .puzzle-grid {
            display: grid;
            gap: 1px;
            background: #333;
            padding: 1px;
            max-width: 100%;
            overflow: hidden;
        }

        .puzzle-piece {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
            touch-action: manipulation;
        }

        .puzzle-piece:hover {
            border-color: #ff6b6b;
        }

        .puzzle-piece.empty {
            background: #ddd;
            cursor: default;
        }

        .puzzle-piece.empty:hover {
            border-color: transparent;
        }

        .moves-counter {
            margin: 10px 0;
            font-size: 18px;
            color: #333;
            font-weight: bold;
        }

        .picture-select {
            margin: 20px 0;
        }

        .picture-option {
            display: inline-block;
            width: 80px;
            height: 80px;
            margin: 5px;
            border: 3px solid transparent;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .picture-option:hover, .picture-option.selected {
            border-color: #ff6b6b;
            transform: scale(1.05);
        }

        .congratulations {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .picture-title {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .new-unlock-message {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: confetti-fall 3s linear infinite;
        }
        
        .confetti:nth-child(2n) { background: #3498db; animation-delay: 0.5s; }
        .confetti:nth-child(3n) { background: #2ecc71; animation-delay: 1s; }
        .confetti:nth-child(4n) { background: #f39c12; animation-delay: 1.5s; }
        .confetti:nth-child(5n) { background: #9b59b6; animation-delay: 2s; }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .back-button {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            margin-top: 15px;
        }

        .game-title {
            font-size: 28px;
            background: linear-gradient(45deg, #ff6b6b, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .loading-message {
            color: #666;
            font-style: italic;
            margin: 10px 0;
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 10px;
                max-width: 95vw;
            }
            
            h1, .game-title {
                font-size: 20px;
            }
            
            h2 {
                font-size: 18px;
            }
            
            .button {
                padding: 10px 15px;
                font-size: 14px;
                margin: 5px;
            }
            
            .moves-counter {
                font-size: 16px;
            }
            
            .puzzle-container {
                margin: 10px auto;
                border: 2px solid #333;
            }
            
            .puzzle-grid {
                gap: 1px;
                padding: 1px;
            }
        }

        @media (max-width: 360px) {
            .game-container {
                padding: 8px;
                max-width: 98vw;
            }
            
            .button {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            h1, .game-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div id="title-screen" class="screen active">
            <h1 class="game-title">ğŸ§© ã§ãã‚‹ã‚“ã§ã™ï¼ãƒ‘ã‚ºãƒ« ğŸ§©</h1>
            <p class="subtitle">æ¥½ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ </p>
            <div class="loading-message" id="loading-message">ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            <button class="button" id="start-button" onclick="goToPictureSelect()" style="display: none;">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>

        <!-- çµµæŸ„é¸æŠç”»é¢ -->
        <div id="picture-select-screen" class="screen">
            <h2>çµµæŸ„ã‚’é¸ã¼ã†ï¼</h2>
            <div class="picture-select" id="picture-options">
                <div class="picture-option selected" onclick="selectPicture(0)" data-picture="0"></div>
            </div>
            <button class="button" onclick="goToDifficultySelect()">ã“ã®çµµæŸ„ã§éŠã¶</button>
            <button class="button back-button" onclick="goToTitle()">æˆ»ã‚‹</button>
        </div>

        <!-- é›£æ˜“åº¦é¸æŠç”»é¢ -->
        <div id="difficulty-select-screen" class="screen">
            <h2>é›£æ˜“åº¦ã‚’é¸ã¼ã†ï¼</h2>
            <div class="difficulty-buttons">
                <button class="button easy" onclick="startGame(3)">ã‹ã‚“ãŸã‚“ (3Ã—3)</button>
                <button class="button normal" onclick="startGame(4)">ãµã¤ã† (4Ã—4)</button>
                <button class="button hard" onclick="startGame(5)">ã‚€ãšã„ (5Ã—5)</button>
                <button class="button oni" onclick="startGame(9)">ãŠã« (9Ã—9)</button>
                <button class="button choyaba" onclick="startGame(11)">ã¡ã‚‡ãƒ¼ãƒ¤ãƒ (11Ã—11)</button>
            </div>
            <button class="button back-button" onclick="goToPictureSelect()">æˆ»ã‚‹</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="screen">
            <h2>ãƒ‘ã‚ºãƒ«ã‚’è§£ã„ã¦ã­ï¼</h2>
            <div class="moves-counter">å‹•ã‹ã—ãŸå›æ•°: <span id="moves">0</span></div>
            <div class="puzzle-container">
                <div id="puzzle-grid" class="puzzle-grid"></div>
            </div>
            <button class="button back-button" onclick="goToDifficultySelect()">é›£æ˜“åº¦é¸æŠã«æˆ»ã‚‹</button>
        </div>

        <!-- ã‚¯ãƒªã‚¢ç”»é¢ -->
        <div id="clear-screen" class="screen">
            <div class="congratulations" id="congratulations-container">
                <h2>ğŸ‰ ãŠã‚ã§ã¨ã†ï¼ ğŸ‰</h2>
                <p>ãƒ‘ã‚ºãƒ«ã‚¯ãƒªã‚¢ï¼</p>
                <div class="picture-title" id="picture-title"></div>
                <p><span id="final-moves"></span>å›ã§å®Œæˆã•ã›ã¾ã—ãŸ</p>
            </div>
            <div id="unlock-message" class="new-unlock-message" style="display: none;">
                <h3>ğŸ†• æ–°ã—ã„çµµæŸ„ã‚’ã‚²ãƒƒãƒˆï¼ ğŸ†•</h3>
                <p id="unlock-title"></p>
            </div>
            <button class="button" onclick="goToPictureSelect()">æ¬¡ã®ãƒ‘ã‚ºãƒ«ã«æŒ‘æˆ¦</button>
            <button class="button back-button" onclick="goToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let currentPicture = 0;
        let currentSize = 3;
        let moves = 0;
        let puzzleGrid = [];
        let gameImages = [];
        let imagesLoaded = false;
        let unlockedPictures = [0]; // æœ€åˆã¯001ã ã‘ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
        let clearedStages = []; // ã‚¯ãƒªã‚¢ã—ãŸã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±
        
        // ç”»åƒã‚¿ã‚¤ãƒˆãƒ«
        const imageTitles = [
            'ã‚ã°ã‚Œç¥­ã‚Š',
            'æ¡œèˆã†æ˜¥',
            'å¤ã®èŠ±ç«',
            'ç´…è‘‰ã®å±±',
            'é›ªåŒ–ç²§'
            // ç”»åƒã‚’è¿½åŠ ã—ãŸæ™‚ã¯ã“ã“ã«ã‚‚ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
        ];

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function goToTitle() {
            showScreen('title-screen');
        }

        function goToPictureSelect() {
            if (!imagesLoaded) {
                alert('ç”»åƒã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }
            updatePictureOptions();
            showScreen('picture-select-screen');
        }

        function goToDifficultySelect() {
            showScreen('difficulty-select-screen');
        }

        // çµµæŸ„é¸æŠ
        function selectPicture(index) {
            currentPicture = index;
            document.querySelectorAll('.picture-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-picture="${index}"]`).classList.add('selected');
        }

        function updatePictureOptions() {
            const container = document.getElementById('picture-options');
            container.innerHTML = '';
            
            // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸç”»åƒã®ã¿è¡¨ç¤º
            unlockedPictures.forEach((pictureIndex, displayIndex) => {
                if (gameImages[pictureIndex]) {
                    const option = document.createElement('div');
                    option.className = 'picture-option' + (displayIndex === 0 ? ' selected' : '');
                    option.style.backgroundImage = `url(${gameImages[pictureIndex]})`;
                    option.setAttribute('data-picture', pictureIndex.toString());
                    option.onclick = () => selectPicture(pictureIndex);
                    
                    // ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºï¼ˆãƒ›ãƒãƒ¼æ™‚ï¼‰
                    option.title = imageTitles[pictureIndex] || `ç”»åƒ ${pictureIndex + 1}`;
                    
                    container.appendChild(option);
                }
            });
            
            // ç¾åœ¨é¸æŠä¸­ã®çµµæŸ„ã‚’æ›´æ–°
            if (unlockedPictures.includes(currentPicture)) {
                selectPicture(currentPicture);
            } else {
                selectPicture(unlockedPictures[0]);
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒã‚’èª­ã¿è¾¼ã‚€
        function loadLocalImages() {
            const imagePaths = [
                'images/001.png'
                // ä»–ã®ç”»åƒãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«è¿½åŠ 
                // 'images/002.png',
                // 'images/003.png'
            ];

            let loadedCount = 0;
            const totalImages = imagePaths.length;

            imagePaths.forEach((path, index) => {
                const img = new Image();
                
                img.onload = function() {
                    // ç”»åƒã‚’æ­£æ–¹å½¢ã«ãƒªã‚µã‚¤ã‚º
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 400;
                    canvas.height = 400;
                    
                    const minSize = Math.min(img.width, img.height);
                    const startX = (img.width - minSize) / 2;
                    const startY = (img.height - minSize) / 2;
                    
                    ctx.drawImage(img, startX, startY, minSize, minSize, 0, 0, 400, 400);
                    
                    gameImages[index] = canvas.toDataURL();
                    loadedCount++;
                    
                    console.log(`ç”»åƒ ${index + 1}/${totalImages} èª­ã¿è¾¼ã¿å®Œäº†: ${path}`);
                    
                    if (loadedCount === totalImages) {
                        onAllImagesLoaded();
                    }
                };
                
                img.onerror = function() {
                    console.log(`ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: ${path}`);
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã‚’ä½œæˆ
                    gameImages[index] = createSampleImage(index);
                    loadedCount++;
                    
                    if (loadedCount === totalImages) {
                        onAllImagesLoaded();
                    }
                };
                
                img.src = path;
            });
        }

        function onAllImagesLoaded() {
            imagesLoaded = true;
            document.getElementById('loading-message').style.display = 'none';
            document.getElementById('start-button').style.display = 'inline-block';
            console.log('ã™ã¹ã¦ã®ç”»åƒã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
            console.log('ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿çµµæŸ„:', unlockedPictures);
        }

        // ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã‚’ä½œæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        function createSampleImage(index) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 300;
            canvas.height = 300;
            
            // å„ç”»åƒã”ã¨ã«ç•°ãªã‚‹è‰²ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const colors = [
                ['#ff6b6b', '#3498db', '#2ecc71'],
                ['#9b59b6', '#e74c3c', '#f39c12'],
                ['#1abc9c', '#34495e', '#e67e22']
            ];
            
            const colorSet = colors[index % colors.length];
            const gradient = ctx.createLinearGradient(0, 0, 300, 300);
            gradient.addColorStop(0, colorSet[0]);
            gradient.addColorStop(0.5, colorSet[1]);
            gradient.addColorStop(1, colorSet[2]);
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 300, 300);
            
            // å›³å½¢ã‚’è¿½åŠ 
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath();
            ctx.arc(80, 80, 30, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.beginPath();
            ctx.arc(220, 80, 40, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.beginPath();
            ctx.arc(150, 220, 50, 0, Math.PI * 2);
            ctx.fill();
            
            // ãƒ†ã‚­ã‚¹ãƒˆ
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`ç”»åƒ${index + 1}`, 150, 150);
            
            return canvas.toDataURL();
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame(size) {
            currentSize = size;
            moves = 0;
            document.getElementById('moves').textContent = moves;
            initializePuzzle();
            showScreen('game-screen');
        }

        // ãƒ‘ã‚ºãƒ«åˆæœŸåŒ–
        function initializePuzzle() {
            const container = document.getElementById('puzzle-grid');
            
            // ç”»é¢ã‚µã‚¤ã‚ºã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ã¦ãƒ‘ã‚ºãƒ«ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            const containerPadding = 60; // ã‚³ãƒ³ãƒ†ãƒŠã®ä½™ç™½
            const screenWidth = window.innerWidth - containerPadding;
            const screenHeight = window.innerHeight - 300; // UIè¦ç´ åˆ†ã‚’é™¤ã
            
            let maxSize;
            if (currentSize <= 4) {
                maxSize = Math.min(screenWidth * 0.85, screenHeight * 0.7, 320);
            } else if (currentSize <= 6) {
                maxSize = Math.min(screenWidth * 0.90, screenHeight * 0.75, 360);
            } else if (currentSize <= 9) {
                maxSize = Math.min(screenWidth * 0.95, screenHeight * 0.8, 380);
            } else {
                // ã¡ã‚‡ãƒ¼ãƒ¤ãƒã¯ç‰¹ã«å°ã•ã
                maxSize = Math.min(screenWidth * 0.98, screenHeight * 0.85, 400);
            }
            
            const pieceSize = Math.floor(maxSize / currentSize);
            
            container.style.gridTemplateColumns = `repeat(${currentSize}, ${pieceSize}px)`;
            container.innerHTML = '';
            
            // ãƒ‘ã‚ºãƒ«ãƒ”ãƒ¼ã‚¹ã®é…åˆ—ã‚’ä½œæˆ
            puzzleGrid = [];
            for (let i = 0; i < currentSize * currentSize - 1; i++) {
                puzzleGrid.push(i);
            }
            puzzleGrid.push(null); // ç©ºã®ãƒ”ãƒ¼ã‚¹
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆå¤§ããªãƒ‘ã‚ºãƒ«ã»ã©å¤šãã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
            shufflePuzzle();
            
            // DOMè¦ç´ ã‚’ä½œæˆ
            renderPuzzle(pieceSize);
        }

        function shufflePuzzle() {
            // è§£ã‘ã‚‹çŠ¶æ…‹ã‚’ä¿è¨¼ã™ã‚‹ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆé›£æ˜“åº¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
            let shuffleCount;
            if (currentSize <= 4) {
                shuffleCount = 1000;
            } else if (currentSize <= 6) {
                shuffleCount = 2000;
            } else if (currentSize <= 9) {
                shuffleCount = 3000;
            } else {
                shuffleCount = 5000; // ã¡ã‚‡ãƒ¼ãƒ¤ãƒã¯ç‰¹åˆ¥ã«å¤šã
            }
            
            for (let i = 0; i < shuffleCount; i++) {
                const emptyIndex = puzzleGrid.indexOf(null);
                const possibleMoves = getPossibleMoves(emptyIndex);
                if (possibleMoves.length > 0) {
                    const randomMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                    [puzzleGrid[emptyIndex], puzzleGrid[randomMove]] = [puzzleGrid[randomMove], puzzleGrid[emptyIndex]];
                }
            }
        }

        function getPossibleMoves(emptyIndex) {
            const moves = [];
            const row = Math.floor(emptyIndex / currentSize);
            const col = emptyIndex % currentSize;
            
            if (row > 0) moves.push(emptyIndex - currentSize); // ä¸Š
            if (row < currentSize - 1) moves.push(emptyIndex + currentSize); // ä¸‹
            if (col > 0) moves.push(emptyIndex - 1); // å·¦
            if (col < currentSize - 1) moves.push(emptyIndex + 1); // å³
            
            return moves;
        }

        function renderPuzzle(pieceSize) {
            const container = document.getElementById('puzzle-grid');
            container.innerHTML = '';
            
            puzzleGrid.forEach((piece, index) => {
                const pieceElement = document.createElement('div');
                pieceElement.className = 'puzzle-piece';
                pieceElement.style.width = `${pieceSize}px`;
                pieceElement.style.height = `${pieceSize}px`;
                
                if (piece === null) {
                    pieceElement.classList.add('empty');
                } else {
                    const row = Math.floor(piece / currentSize);
                    const col = piece % currentSize;
                    const bgX = -(col * pieceSize);
                    const bgY = -(row * pieceSize);
                    const totalSize = pieceSize * currentSize;
                    
                    pieceElement.style.backgroundImage = `url(${gameImages[currentPicture]})`;
                    pieceElement.style.backgroundSize = `${totalSize}px ${totalSize}px`;
                    pieceElement.style.backgroundPosition = `${bgX}px ${bgY}px`;
                    
                    pieceElement.onclick = () => movePiece(index);
                    
                    // ã‚¿ãƒƒãƒæ“ä½œå¯¾å¿œ
                    pieceElement.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        movePiece(index);
                    });
                }
                
                container.appendChild(pieceElement);
            });
        }

        function movePiece(clickedIndex) {
            const emptyIndex = puzzleGrid.indexOf(null);
            const possibleMoves = getPossibleMoves(emptyIndex);
            
            if (possibleMoves.includes(clickedIndex)) {
                // ãƒ”ãƒ¼ã‚¹ã‚’ç§»å‹•
                [puzzleGrid[emptyIndex], puzzleGrid[clickedIndex]] = [puzzleGrid[clickedIndex], puzzleGrid[emptyIndex]];
                moves++;
                document.getElementById('moves').textContent = moves;
                
                // ãƒ‘ã‚ºãƒ«ã‚µã‚¤ã‚ºã«å¿œã˜ã¦å†è¨ˆç®—ï¼ˆåˆæœŸåŒ–ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                const containerPadding = 60;
                const screenWidth = window.innerWidth - containerPadding;
                const screenHeight = window.innerHeight - 300;
                
                let maxSize;
                if (currentSize <= 4) {
                    maxSize = Math.min(screenWidth * 0.85, screenHeight * 0.7, 320);
                } else if (currentSize <= 6) {
                    maxSize = Math.min(screenWidth * 0.90, screenHeight * 0.75, 360);
                } else if (currentSize <= 9) {
                    maxSize = Math.min(screenWidth * 0.95, screenHeight * 0.8, 380);
                } else {
                    maxSize = Math.min(screenWidth * 0.98, screenHeight * 0.85, 400);
                }
                
                const pieceSize = Math.floor(maxSize / currentSize);
                renderPuzzle(pieceSize);
                
                // ã‚¯ãƒªã‚¢ãƒã‚§ãƒƒã‚¯
                if (checkWin()) {
                    setTimeout(showClear, 500);
                }
            }
        }

        function checkWin() {
            for (let i = 0; i < puzzleGrid.length - 1; i++) {
                if (puzzleGrid[i] !== i) return false;
            }
            return puzzleGrid[puzzleGrid.length - 1] === null;
        }

        function showClear() {
            document.getElementById('final-moves').textContent = moves;
            
            // ã‚¯ãƒªã‚¢ã—ãŸçµµæŸ„ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
            const pictureTitle = imageTitles[currentPicture] || `ç”»åƒ ${currentPicture + 1}`;
            document.getElementById('picture-title').textContent = `ã‚¿ã‚¤ãƒˆãƒ«ï¼š${pictureTitle}`;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢æƒ…å ±ã‚’ä¿å­˜
            const stageKey = `${currentPicture}-${currentSize}`;
            if (!clearedStages.includes(stageKey)) {
                clearedStages.push(stageKey);
                saveGameData();
            }
            
            // æ–°ã—ã„çµµæŸ„ã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯åˆ¤å®š
            checkAndUnlockNewPicture();
            
            // ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            createConfetti();
            
            showScreen('clear-screen');
        }
        
        // æ–°ã—ã„çµµæŸ„ã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯åˆ¤å®š
        function checkAndUnlockNewPicture() {
            const totalImages = imageTitles.length;
            
            // ã¾ã ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„çµµæŸ„ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (unlockedPictures.length < totalImages && Math.random() < 0.7) { // 70%ã®ç¢ºç‡
                const availableImages = [];
                for (let i = 0; i < totalImages; i++) {
                    if (!unlockedPictures.includes(i) && gameImages[i]) {
                        availableImages.push(i);
                    }
                }
                
                if (availableImages.length > 0) {
                    // ãƒ©ãƒ³ãƒ€ãƒ ã«æ–°ã—ã„çµµæŸ„ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
                    const newPictureIndex = availableImages[Math.floor(Math.random() * availableImages.length)];
                    unlockedPictures.push(newPictureIndex);
                    saveGameData();
                    
                    // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const unlockTitle = imageTitles[newPictureIndex] || `ç”»åƒ ${newPictureIndex + 1}`;
                    document.getElementById('unlock-title').textContent = `ã€Œ${unlockTitle}ã€ãŒã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼`;
                    document.getElementById('unlock-message').style.display = 'block';
                } else {
                    document.getElementById('unlock-message').style.display = 'none';
                }
            } else {
                document.getElementById('unlock-message').style.display = 'none';
            }
        }
        
        // ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function createConfetti() {
            const container = document.getElementById('congratulations-container');
            
            // æ—¢å­˜ã®ç´™å¹é›ªã‚’å‰Šé™¤
            const existingConfetti = container.querySelectorAll('.confetti');
            existingConfetti.forEach(confetti => confetti.remove());
            
            // æ–°ã—ã„ç´™å¹é›ªã‚’ä½œæˆ
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    container.appendChild(confetti);
                    
                    // 3ç§’å¾Œã«å‰Šé™¤
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 4000);
                }, i * 50);
            }
        }
        
        // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveGameData() {
            const gameData = {
                unlockedPictures: unlockedPictures,
                clearedStages: clearedStages
            };
            localStorage.setItem('slidepuzzle_gamedata', JSON.stringify(gameData));
        }
        
        // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadGameData() {
            try {
                const savedData = localStorage.getItem('slidepuzzle_gamedata');
                if (savedData) {
                    const gameData = JSON.parse(savedData);
                    unlockedPictures = gameData.unlockedPictures || [0];
                    clearedStages = gameData.clearedStages || [];
                    console.log('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', gameData);
                }
            } catch (error) {
                console.log('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                unlockedPictures = [0];
                clearedStages = [];
            }
        }

        // åˆæœŸåŒ–
        window.onload = function() {
            console.log('ã‚²ãƒ¼ãƒ é–‹å§‹ - ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...');
            loadGameData(); // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadLocalImages();
        }
    </script>
</body>
</html>
